name: Build archlinux kernel

on:
  push:
    branches:
      - main
      - master
      - uso-de-modprobedb
    # Solo trigerea cuando se modifican archivos relevantes al build
    paths:
      - "customization.cfg"
      - "essential.myfrag"
      - "modprobed.db"
      - ".github/workflows/arch-builder.yml"
      - "linux-tkg-config/**"
      - "linux-tkg-patches/**"

  workflow_dispatch:
    inputs:
      _cpusched:
        description: "CPU scheduler (bmq, pds, bore, eevdf)"
        required: true
        default: "pds"

  workflow_call:
    inputs:
      _cpusched:
        required: true
        type: string

# ─────────────────────────────────────────────
# Build environment variables passed to linux-tkg
# These override values in customization.cfg
# ─────────────────────────────────────────────
env:
  # Target CPU micro-architecture optimization
  # See: https://github.com/graysky2/kernel_compiler_patch
  _processor_opt: "silvermont"

  # Use clang/LLVM as compiler
  _compiler: "llvm"

  # Clang LTO mode: "no", "thin" or "full"
  # thin = faster build, multiple threads
  # full = slower, potentially better runtime perf
  _lto_mode: "thin"

  # Disable ccache in CI — no benefit without persistent cache
  # (we handle caching separately via actions/cache below)
  _noccache: "true"

  # Git mirror to fetch kernel sources from
  _git_mirror: "gregkh"

  # Output directory for built packages
  PKGDEST: "/tmp/linux-tkg"

  # Aggressively disable debug symbols and kernel debugging features
  _debugdisable: "true"

  # Strip kernel and modules from debug symbols
  _STRIP: "true"

  # Use /tmp for kernel work and source folders (faster I/O in CI)
  _kernel_work_folder: "/tmp"
  _kernel_source_folder: "/tmp"

  # Don't generate a fallback initramfs
  _nofallback: "true"

  # Path to modprobed.db — used if _modprobeddb is enabled in customization.cfg
  _modprobeddb_db_path: ${{ github.workspace }}/modprobed.db

jobs:
  build-kernel:
    runs-on: ubuntu-latest
    container: archlinux:latest

    env:
      # CPU scheduler — comes from workflow input or defaults to empty (prompts)
      _cpusched: ${{ inputs._cpusched }}

    steps:
      # ── Step 1 ──────────────────────────────────────────────────────────────
      # Install git first so actions/checkout uses it instead of the JS fallback
      # ────────────────────────────────────────────────────────────────────────
      - name: "1 · Install git"
        run: pacman -Syu --noconfirm git

      # ── Step 2 ──────────────────────────────────────────────────────────────
      # Checkout the linux-tkg repository (PKGBUILD + patches + config)
      # ────────────────────────────────────────────────────────────────────────
      - name: "2 · Checkout linux-tkg"
        uses: actions/checkout@v4

      # ── Step 3 ──────────────────────────────────────────────────────────────
      # Install all build dependencies.
      # Also creates a non-root user because makepkg refuses to run as root.
      # ────────────────────────────────────────────────────────────────────────
      - name: "3 · Install build dependencies and prepare non-root user"
        run: |
          pacman -Syu --noconfirm \
            base-devel gcc binutils libelf elfutils pahole sudo ccache

          # Create unprivileged user with passwordless sudo
          useradd user -G wheel
          echo "user ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

          # Give the new user ownership of the workspace and /tmp
          chown user -R ..
          chown user -R /tmp

      # ── Step 4 ──────────────────────────────────────────────────────────────
      # Restore ccache from cache to speed up repeat builds.
      # Cache key includes the scheduler so different schedulers don't share cache.
      # ────────────────────────────────────────────────────────────────────────
      - name: "4 · Restore ccache"
        uses: actions/cache@v4
        with:
          path: /home/user/.ccache
          key: ccache-arch-${{ env._cpusched }}-${{ github.sha }}
          restore-keys: |
            ccache-arch-${{ env._cpusched }}-
            ccache-arch-

      # ── Step 5 ──────────────────────────────────────────────────────────────
      # Set correct ownership on the restored ccache directory
      # (actions/cache restores as root inside the container)
      # ────────────────────────────────────────────────────────────────────────
      - name: "5 · Fix ccache ownership"
        run: |
          mkdir -p /home/user/.ccache
          chown -R user /home/user/.ccache

      # ── Step 6 ──────────────────────────────────────────────────────────────
      # Main build step — runs makepkg as the non-root user.
      # linux-tkg reads env vars + customization.cfg to configure the build.
      # "yes ''" auto-answers any interactive prompts with the default value.
      # ────────────────────────────────────────────────────────────────────────
      - name: "6 · Compile kernel"
        run: |
          su --preserve-environment user -c "yes '' | makepkg --noconfirm -s"

      # ── Step 7 ──────────────────────────────────────────────────────────────
      # Rename the generated kernel config to include scheduler name,
      # making it easy to identify which config belongs to which build.
      # ────────────────────────────────────────────────────────────────────────
      - name: "7 · Rename kernel config"
        run: mv kernelconfig.new kernelconfig.arch.${{ env._cpusched }}.txt

      # ── Step 8 ──────────────────────────────────────────────────────────────
      # Extract kernel version AND scheduler from the built package name.
      # Extracting scheduler from the package avoids issues when _cpusched
      # is empty (e.g. on push triggers without workflow_dispatch input).
      # Example package: linux612-tkg-pds-llvm-6.12.74-273-x86_64.pkg.tar.zst
      # ────────────────────────────────────────────────────────────────────────
      - name: "8 · Get kernel version and scheduler"
        id: kver
        run: |
          PKG=$(find ${{ env.PKGDEST }} -name "linux*.pkg.tar.zst" \
            ! -name "*headers*" ! -name "*docs*" | head -n1)
          echo "Package found: $PKG"

          # Extract version (e.g. 6.12.74)
          VERSION=$(basename "$PKG" | grep -oP '\d+\.\d+\.\d+' | head -n1)

          # Extract scheduler from package name (e.g. pds, eevdf, bore)
          SCHED=$(basename "$PKG" | grep -oP '(?<=tkg-)[a-z]+(?=-llvm|-\d|-)' | head -n1)

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "sched=$SCHED" >> $GITHUB_OUTPUT
          echo "Kernel: $VERSION | Scheduler: $SCHED"

      # ── Step 9 ──────────────────────────────────────────────────────────────
      # Upload build artifacts (packages + config) for download from the
      # Actions run page, independent of releases.
      # ────────────────────────────────────────────────────────────────────────
      - name: "9 · Upload artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: arch-kernel-packages-${{ steps.kver.outputs.sched }}
          path: |
            ${{ env.PKGDEST }}/linux*.pkg.tar.zst
            kernelconfig*.txt

      # ── Step 10 ─────────────────────────────────────────────────────────────
      # Create a GitHub Release using softprops/action-gh-release.
      # Does NOT require gh CLI installed inside the container.
      # Runs outside the Arch container in the Ubuntu runner environment.
      # ────────────────────────────────────────────────────────────────────────
      - name: "10 · Create GitHub Release"
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ steps.kver.outputs.version }}-${{ steps.kver.outputs.sched }}"
          name: "Linux ${{ steps.kver.outputs.version }} · ${{ steps.kver.outputs.sched }} · silvermont (Arch)"
          body: |
            ## linux-tkg ${{ steps.kver.outputs.version }} — `${{ steps.kver.outputs.sched }}` scheduler

            ### Target hardware
            | Property | Value |
            |---|---|
            | Architecture | x86_64 |
            | CPU | Intel Celeron N2807 (Bay Trail / Silvermont) |
            | Compiler | LLVM/Clang with ThinLTO |
            | Distribution | Arch Linux |

            ### Build configuration
            | Option | Value |
            |---|---|
            | CPU scheduler | `${{ steps.kver.outputs.sched }}` |
            | LTO mode | thin |
            | Debug symbols | disabled |
            | modprobed-db | enabled |

            ### Installation
            ```bash
            sudo pacman -U linux*${{ steps.kver.outputs.sched }}*.pkg.tar.zst linux*${{ steps.kver.outputs.sched }}*-headers*.pkg.tar.zst
            ```

            > Built automatically by GitHub Actions from [linux-tkg](https://github.com/Frogging-Family/linux-tkg).
          files: |
            ${{ env.PKGDEST }}/linux*.pkg.tar.zst
            kernelconfig.arch.${{ steps.kver.outputs.sched }}.txt
          make_latest: true
          fail_on_unmatched_files: false
