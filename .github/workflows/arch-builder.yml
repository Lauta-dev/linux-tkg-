name: Build archlinux kernel

on:
  push:
    branches:
      - main
      - master
      - uso-de-modprobedb

# ─────────────────────────────────────────────
# Build environment variables passed to linux-tkg
# These override values in customization.cfg
# ─────────────────────────────────────────────
env:
  _processor_opt: "silvermont"
  _compiler: "gcc"
  _lto_mode: "none"
  _noccache: "false"          # ccache habilitado
  _git_mirror: "gregkh"
  PKGDEST: "/tmp/linux-tkg"
  _debugdisable: "true"
  _STRIP: "true"
  _kernel_work_folder: "/tmp"
  _kernel_source_folder: "/tmp"
  _nofallback: "true"
  _localmodcfg: "true"        # compilar solo modulos del modprobed.db
  _modprobeddb_db_path: ${{ github.workspace }}/modprobed.db


jobs:
  build-kernel:
    runs-on: ubuntu-latest
    container: archlinux:latest

    env:
      _cpusched: pds

    steps:
      # ── Step 1 ──────────────────────────────────────────────────────────────
      - name: "1 · Install git"
        run: pacman -Syu --noconfirm git

      # ── Step 2 ──────────────────────────────────────────────────────────────
      - name: "2 · Checkout linux-tkg"
        uses: actions/checkout@v4

      # ── Step 3 ──────────────────────────────────────────────────────────────
      - name: "3 · Install build dependencies and prepare non-root user"
        run: |
          pacman -Syu --noconfirm \
            base-devel gcc binutils libelf elfutils pahole sudo ccache

          useradd user -G wheel
          echo "user ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

          chown user -R ..
          chown user -R /tmp

      # ── Step 4 ──────────────────────────────────────────────────────────────
      # Cache key usa ref en lugar de sha para reutilizar entre commits
      # ────────────────────────────────────────────────────────────────────────
      - name: "4 · Restore ccache"
        uses: actions/cache@v4
        with:
          path: /home/user/.ccache
          key: ccache-arch-${{ env._cpusched }}-${{ github.ref }}
          restore-keys: |
            ccache-arch-${{ env._cpusched }}-
            ccache-arch-

      # ── Step 5 ──────────────────────────────────────────────────────────────
      - name: "5 · Fix ccache ownership"
        run: |
          mkdir -p /home/user/.ccache
          chown -R user /home/user/.ccache

      # ── Step 6 ──────────────────────────────────────────────────────────────
      - name: "6 · Compile kernel"
        run: |
          su --preserve-environment user -c "yes '' | makepkg --noconfirm -s"

      # ── Step 7 ──────────────────────────────────────────────────────────────
      - name: "7 · Rename kernel config"
        run: mv kernelconfig.new kernelconfig.arch.${{ env._cpusched }}.txt

      # ── Step 8 ──────────────────────────────────────────────────────────────
      - name: "8 · Get kernel version and scheduler"
        id: kver
        run: |
          PKG=$(find ${{ env.PKGDEST }} -name "linux*.pkg.tar.zst" \
            ! -name "*headers*" ! -name "*docs*" | head -n1)
          echo "Package found: $PKG"

          VERSION=$(basename "$PKG" | grep -oP '\d+\.\d+\.\d+' | head -n1)
          SCHED=$(basename "$PKG" | grep -oP '(?<=tkg-)[a-z]+(?=-llvm|-\d|-)' | head -n1)

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "sched=$SCHED" >> $GITHUB_OUTPUT
          echo "Kernel: $VERSION | Scheduler: $SCHED"

      # ── Step 9 ──────────────────────────────────────────────────────────────
      - name: "9 · Upload artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: arch-kernel-packages-${{ steps.kver.outputs.sched }}
          path: |
            ${{ env.PKGDEST }}/linux*.pkg.tar.zst
            kernelconfig*.txt

      # ── Step 10 ─────────────────────────────────────────────────────────────
      - name: "10 · Create GitHub Release"
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ steps.kver.outputs.version }}-${{ steps.kver.outputs.sched }}"
          name: "Linux ${{ steps.kver.outputs.version }} · ${{ steps.kver.outputs.sched }} · silvermont (Arch)"
          body: |
            ## linux-tkg ${{ steps.kver.outputs.version }} — `${{ steps.kver.outputs.sched }}` scheduler

            ### Target hardware
            | Property | Value |
            |---|---|
            | Architecture | x86_64 |
            | CPU | Intel Celeron N2807 (Bay Trail / Silvermont) |
            | Compiler | GCC |
            | Distribution | Arch Linux |

            ### Build configuration
            | Option | Value |
            |---|---|
            | CPU scheduler | `${{ steps.kver.outputs.sched }}` |
            | LTO mode | none |
            | Debug symbols | disabled |
            | modprobed-db | enabled |
            | localmodcfg | enabled |

          files: |
            ${{ env.PKGDEST }}/linux*.pkg.tar.zst
            kernelconfig.arch.${{ steps.kver.outputs.sched }}.txt
          make_latest: true
          fail_on_unmatched_files: false
